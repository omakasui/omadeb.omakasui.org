---
export interface Props {
  selector?: string;
}

const { selector = ".markdown-content" } = Astro.props;
---

<script is:inline define:vars={{ selector }}>
  // Generate heading slug (must be inline for browser execution)
  const generateHeadingSlug = (text) => {
    // Replica github-slugger logic (used by Astro)
    return text
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, "")
      .replace(/[\s_]+/g, "-")
      .replace(/^-+|-+$/g, "");
  };

  function initMarkdownEnhancements() {
    /**
     * Function to add heading links (h2, h3)
     * @returns {void}
     */
    function addHeadingLinks() {
      const headerElements = document.querySelectorAll(
        `${selector} h2, ${selector} h3`,
      );

      headerElements.forEach((header) => {
        // Generate ID if not present
        if (!header.id) {
          const text = header.textContent || "";
          header.id = generateHeadingSlug(text);
        }

        // Skip if link already exists
        if (header.querySelector(".heading-links")) return;

        const text = header.textContent || "";

        // Create link icon
        const linkIcon = document.createElement("a");
        linkIcon.className = "heading-links";
        linkIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="1em" height="1em" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`;
        linkIcon.setAttribute("aria-label", `Link to ${text}`);
        linkIcon.setAttribute("href", `#${header.id}`);
        linkIcon.title = "Copy link to clipboard";

        // Add click handler to copy link
        linkIcon.addEventListener("click", async (e) => {
          e.preventDefault();
          const url = `${window.location.origin}${window.location.pathname}#${header.id}`;

          try {
            await navigator.clipboard.writeText(url);
          } catch (err) {
            console.error("Failed to copy link:", err);
          }
        });

        header.appendChild(linkIcon);
      });
    }

    /**
     * Function to add copy buttons to code blocks
     * @returns {void}
     */
    function addCopyButtonsToCodeBlocks() {
      const codeBlocks = document.querySelectorAll(`${selector} pre`);

      codeBlocks.forEach((block) => {
        // Skip if button already exists
        if (block.querySelector(".code-copy-button")) return;

        const codeElement = block.querySelector("code");
        if (!codeElement) return;

        const button = document.createElement("button");
        button.className = "code-copy-button";
        button.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
        button.title = "Copy code to clipboard";
        button.setAttribute("aria-label", "Copy code to clipboard");

        button.addEventListener("click", async () => {
          try {
            const text = codeElement.textContent || "";
            await navigator.clipboard.writeText(text);

            // Visual feedback
            const originalIcon = button.innerHTML;
            button.innerHTML =
              '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em" aria-hidden="true"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
            button.style.color = "var(--color-success)";

            setTimeout(() => {
              button.innerHTML = originalIcon;
              button.style.color = "";
            }, 2000);
          } catch (err) {
            console.error("Failed to copy code:", err);
          }
        });

        block.appendChild(button);
      });
    }

    /**
     * Function to add lightbox functionality to images
     * @returns {void}
     */
    function addImageLightbox() {
      const images = document.querySelectorAll(`${selector} img`);

      images.forEach((img) => {
        // Skip if already has lightbox
        if (img.classList.contains("lightbox-enabled")) return;

        img.classList.add("lightbox-enabled");
        img.style.cursor = "pointer";
        img.title = img.alt || "Click to enlarge";

        img.addEventListener("click", () => {
          openImageLightbox(img.src, img.alt);
        });
      });
    }

    /**
     * Function to open image lightbox
     * @param {string} src - Image source URL
     * @param {string} alt - Image alt text
     * @returns {void}
     */
    function openImageLightbox(src, alt) {
      // Create lightbox if doesn't exist
      let lightbox = document.getElementById("image-lightbox");

      if (!lightbox) {
        lightbox = document.createElement("div");
        lightbox.id = "image-lightbox";
        lightbox.className = "image-lightbox hidden";
        lightbox.innerHTML = `
          <div class="image-lightbox-backdrop"></div>
          <div class="image-lightbox-content">
            <button class="image-lightbox-close" aria-label="Close">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1em" height="1em" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
            <img class="image-lightbox-img" src="" alt="" />
          </div>
        `;
        document.body.appendChild(lightbox);

        // Add event listeners
        const backdrop = lightbox.querySelector(".image-lightbox-backdrop");
        const closeBtn = lightbox.querySelector(".image-lightbox-close");

        const closeLightbox = () => {
          lightbox.classList.add("hidden");
          document.body.style.overflow = "";
        };

        backdrop.addEventListener("click", closeLightbox);
        closeBtn.addEventListener("click", closeLightbox);

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && !lightbox.classList.contains("hidden")) {
            closeLightbox();
          }
        });
      }

      // Set image and show lightbox
      const lightboxImg = lightbox.querySelector(".image-lightbox-img");
      lightboxImg.src = src;
      lightboxImg.alt = alt || "";

      lightbox.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    // Run all enhancements
    addHeadingLinks();
    addCopyButtonsToCodeBlocks();
    addImageLightbox();
    initCodeTabs();
    initSpoilers();
    initDetails();
  }

  /**
   * Initialise details/summary elements within markdown content with smooth open/close animations
   */
  function initDetails() {
    document.querySelectorAll(`${selector} details`).forEach((details) => {
      // Skip if already initialised
      if (details.dataset.detailsInit) return;
      details.dataset.detailsInit = "1";

      const summary = details.querySelector("summary");
      if (!summary) return;

      // Two-level wrap: wrapper is what we animate (height only),
      // inner holds the padding so it's baked into scrollHeight
      // and never animated separately â€” no jump at end of animation.
      const wrapper = document.createElement("div");
      wrapper.className = "details-body-wrapper";
      const inner = document.createElement("div");
      inner.className = "details-body-inner";
      Array.from(details.childNodes).forEach((node) => {
        if (node !== summary) inner.appendChild(node);
      });
      wrapper.appendChild(inner);
      details.appendChild(wrapper);

      // Collapsed by default if not open
      if (!details.open) {
        wrapper.style.height = "0px";
        wrapper.style.overflow = "hidden";
      }

      summary.addEventListener("click", (e) => {
        e.preventDefault();

        if (details.open) {
          // Closing
          const startH = wrapper.scrollHeight;
          wrapper.style.overflow = "hidden";
          const anim = wrapper.animate(
            [{ height: startH + "px" }, { height: "0px" }],
            { duration: 280, easing: "ease" },
          );
          anim.onfinish = () => {
            wrapper.style.height = "0px";
            details.removeAttribute("open");
          };
        } else {
          // Opening
          details.setAttribute("open", "");
          const endH = wrapper.scrollHeight;
          wrapper.style.overflow = "hidden";
          const anim = wrapper.animate(
            [{ height: "0px" }, { height: endH + "px" }],
            { duration: 280, easing: "ease" },
          );
          anim.onfinish = () => {
            wrapper.style.height = "auto";
            wrapper.style.overflow = "";
          };
        }
      });
    });
  }

  /**
   * Initialise spoiler elements (.spoiler) which toggle a "revealed" class on click
   */
  function initSpoilers() {
    document.querySelectorAll(".markdown-content .spoiler").forEach((el) => {
      if (el.dataset.spoilerInit) return;
      el.dataset.spoilerInit = "1";
      el.addEventListener("click", () => el.classList.toggle("revealed"));
    });
  }

  /**
   * Initialise tabbed code blocks (.code-tabs)
   */
  function initCodeTabs() {
    document.querySelectorAll(".code-tabs").forEach((tabGroup) => {
      // Skip if already initialised
      if (tabGroup.dataset.tabsInit) return;
      tabGroup.dataset.tabsInit = "1";

      tabGroup.querySelectorAll(".code-tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = btn.dataset.tabIndex;

          tabGroup
            .querySelectorAll(".code-tab-btn")
            .forEach((b) => b.classList.remove("active"));
          tabGroup
            .querySelectorAll(".code-tab-panel")
            .forEach((p) => p.classList.remove("active"));

          btn.classList.add("active");
          tabGroup
            .querySelector(`.code-tab-panel[data-tab-index="${idx}"]`)
            ?.classList.add("active");
        });
      });
    });
  }

  // Initialize on page load
  initMarkdownEnhancements();

  // Re-initialize on view transitions
  document.addEventListener("astro:page-load", initMarkdownEnhancements);
</script>
